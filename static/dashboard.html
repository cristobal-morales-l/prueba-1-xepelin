<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard | Prueba Growth Engineer</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: sans-serif; margin: 40px; background: #f9fafb; color: #222; }
    h2, h3 { margin-top: 18px; }
    table { width: 80%; border-collapse: collapse; margin-top: 12px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background: #eee; }
    .muted { opacity: 0.6; cursor: not-allowed; }
    .changed { outline: 2px solid #0aa; }
    button { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; background: #0284c7; color: white; }
    button:hover:not(:disabled) { background: #0369a1; }
  </style>
</head>
<body>

  <h2>Dashboard de Tasas</h2>
  <button onclick="logout()">Cerrar sesi√≥n</button>

  <h3>Vista actual (Google Sheet privado con credenciales):</h3>
  <table id="tablaView"></table>

  <h3>Editor de Tasas:</h3>
  <table id="tablaEdit"></table>

  <script>
    let data = [];

    // ==============================
    // Reintento autom√°tico en fallos
    // ==============================
    async function postWithRetry(url, options, retries = 3) {
      for (let i = 0; i < retries; i++) {
        try {
          const res = await fetch(url, options);
          if (!res.ok) throw new Error(await res.text());
          return res;
        } catch (err) {
          if (i === retries - 1) throw err;
          console.warn(`‚è≥ Reintentando conexi√≥n... intento ${i + 1}`);
          await new Promise(r => setTimeout(r, 2000));
        }
      }
    }

    // -------------------------------
    // Autenticaci√≥n
    // -------------------------------
    function logout() {
      localStorage.removeItem('auth');
      window.location.href = 'index.html';
    }

    function checkAuth() {
      if (localStorage.getItem('auth') !== 'ok') {
        window.location.href = 'index.html';
      }
    }

    // -------------------------------
    // Cargar datos desde backend (Sheet real con credenciales)
    // -------------------------------
    async function cargarDatos() {
      try {
        const res = await fetch("/api/data", {
          cache: "no-store",
          headers: { "Cache-Control": "no-cache, no-store, must-revalidate" }
        });
        if (!res.ok) throw new Error("Error al obtener datos del backend");

        const json = await res.json();
        if (!Array.isArray(json)) throw new Error("Formato inesperado");

        data = json.map(r => ({
          idOp: parseInt(r.idOp),
          tasa: parseFloat(r.tasa),
          email: r.email
        }));

        renderView();
        renderEditor();
        console.log("‚úÖ Datos cargados desde backend:", data);
      } catch (err) {
        console.error("‚ùå Error cargando datos:", err);
        alert("‚ö†Ô∏è Error cargando datos: " + err.message);
      }
    }

    // -------------------------------
    // Renderizar vista (solo lectura)
    // -------------------------------
    function renderView() {
      const t = document.getElementById("tablaView");
      if (!data.length) {
        t.innerHTML = "<tr><td colspan='3'>Cargando...</td></tr>";
        return;
      }
      t.innerHTML = `
        <tr><th>ID</th><th>Tasa</th><th>Email</th></tr>
        ${data.map(d => `
          <tr>
            <td>${d.idOp}</td>
            <td>${d.tasa}</td>
            <td>${d.email}</td>
          </tr>`).join("")}
      `;
    }

    // -------------------------------
    // Renderizar tabla editable
    // -------------------------------
    function renderEditor() {
      const table = document.getElementById("tablaEdit");
      if (!data.length) {
        table.innerHTML = "<tr><td colspan='4'>Cargando datos...</td></tr>";
        return;
      }

      table.innerHTML = `
        <tr><th>ID</th><th>Tasa</th><th>Email</th><th>Acci√≥n</th></tr>
        ${data.map(d => `
          <tr id="row-${d.idOp}">
            <td>${d.idOp}</td>
            <td>
              <input type="number" step="0.01" id="tasa-${d.idOp}" value="${d.tasa}" oninput="markChanged(${d.idOp})">
            </td>
            <td>${d.email}</td>
            <td>
              <button id="btn-${d.idOp}" class="muted" onclick="guardar(${d.idOp})" disabled>Guardar</button>
            </td>
          </tr>`).join("")}
      `;
    }

    // -------------------------------
    // Detectar cambios
    // -------------------------------
    function markChanged(idOp) {
      const d = data.find(x => x.idOp === idOp);
      if (!d) return;

      const input = document.getElementById(`tasa-${idOp}`);
      const btn = document.getElementById(`btn-${idOp}`);
      const valor = parseFloat(input.value);

      if (!isNaN(valor) && valor !== d.tasa) {
        btn.disabled = false;
        btn.classList.remove('muted');
        input.classList.add('changed');
      } else {
        btn.disabled = true;
        btn.classList.add('muted');
        input.classList.remove('changed');
      }
    }

    // -------------------------------
    // Guardar cambios (API Flask)
    // -------------------------------
    async function guardar(idOp) {
      const d = data.find(x => x.idOp === idOp);
      if (!d) return;

      const input = document.getElementById(`tasa-${idOp}`);
      const btn = document.getElementById(`btn-${idOp}`);
      const nuevaTasa = parseFloat(input.value);

      if (isNaN(nuevaTasa)) return alert("Ingresa una tasa v√°lida.");
      if (nuevaTasa === d.tasa) return alert("Sin cambios detectados.");

      const body = { idOp: d.idOp, tasa: nuevaTasa, email: d.email };

      btn.disabled = true;
      btn.classList.add("muted");
      btn.textContent = "Enviando‚Ä¶";

      try {
        const res = await postWithRetry("/api/guardar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        const result = await res.json();
        if (!res.ok) throw new Error(result.error || result.msg || "Error en el servidor");

        alert(`‚úÖ ${result.msg || "Tasa actualizada correctamente."}`);

        await cargarDatos(); // vuelve a leer desde el backend real (no cacheado)
      } catch (err) {
        console.error("‚ùå Error al guardar:", err);
        alert("‚ö†Ô∏è Error: " + err.message);
      } finally {
        btn.textContent = "Guardar";
        markChanged(idOp);
      }
    }

    // -------------------------------
    // Inicializaci√≥n
    // -------------------------------
    checkAuth();
    cargarDatos();

    // üîÅ Actualiza la tabla autom√°ticamente cada 60 segundos
    setInterval(cargarDatos, 60000);
  </script>
</body>
</html>
