<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard | Prueba Growth Engineer</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: sans-serif; margin: 40px; }
    .muted { opacity: 0.6; cursor: not-allowed; }
    .changed { outline: 2px solid #0aa; }
    table { width: 70%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    h2, h3 { margin-top: 18px; }
  </style>
</head>
<body>

  <h2>Dashboard de Tasas</h2>
  <button onclick="logout()">Cerrar sesi√≥n</button>

  <h3>Google Sheet embebido:</h3>
  <iframe 
    src="https://docs.google.com/spreadsheets/d/e/2PACX-1vS1C_LR5_KDL3EY4uWGC7eycpneFZ2Afld4WVctIx443v3W79S-A19_NROWkFAiW4b0S8L57zf-O426/pubhtml"
    width="100%" 
    height="400">
  </iframe>

  <h3>Editor de Tasas:</h3>
  <table id="tabla"></table>

  <script>
    let data = [];

    // ==============================
    // Reintento autom√°tico del fetch
    // ==============================
    async function postWithRetry(url, options, retries = 3) {
      for (let i = 0; i < retries; i++) {
        try {
          const res = await fetch(url, options);
          if (!res.ok) throw new Error(await res.text());
          return res;
        } catch (err) {
          if (i === retries - 1) throw err;
          console.warn(`‚è≥ Reintentando conexi√≥n... intento ${i + 1}`);
          await new Promise(r => setTimeout(r, 2000));
        }
      }
    }

    // -------------------------------
    // Autenticaci√≥n
    // -------------------------------
    function logout() {
      localStorage.removeItem('auth');
      window.location.href = 'index.html';
    }

    function checkAuth() {
      if (localStorage.getItem('auth') !== 'ok') {
        window.location.href = 'index.html';
      }
    }

    // -------------------------------
    // Cargar datos desde el backend (no CSV)
    // -------------------------------
    async function cargarDatos() {
      try {
        const res = await fetch("/api/data", {
          cache: "no-store",
          headers: { "Cache-Control": "no-cache, no-store, must-revalidate" }
        });

        const json = await res.json();
        if (!Array.isArray(json)) throw new Error("Formato inesperado");

        data = json.map(r => ({
          idOp: parseInt(r.idOp),
          tasa: parseFloat(r.tasa),
          email: r.email
        }));

        renderTable();
        console.log("‚úÖ Datos actualizados desde el backend:", data);
      } catch (err) {
        alert("‚ö†Ô∏è Error cargando datos: " + err.message);
      }
    }

    // -------------------------------
    // Renderizar tabla
    // -------------------------------
    function renderTable() {
      const table = document.getElementById("tabla");
      if (!data.length) {
        table.innerHTML = "<tr><td colspan='4'>Cargando datos...</td></tr>";
        return;
      }

      table.innerHTML = `
        <tr><th>ID</th><th>Tasa</th><th>Email</th><th>Acci√≥n</th></tr>
        ${data.map(d => `
          <tr id="row-${d.idOp}">
            <td>${d.idOp}</td>
            <td>
              <input type="number" step="0.01" id="tasa-${d.idOp}" value="${d.tasa}" oninput="markChanged(${d.idOp})">
            </td>
            <td>${d.email}</td>
            <td>
              <button id="btn-${d.idOp}" class="muted" onclick="guardar(${d.idOp})" disabled>Guardar</button>
            </td>
          </tr>`).join("")}
      `;
    }

    // -------------------------------
    // Detectar cambios en tasa
    // -------------------------------
    function markChanged(idOp) {
      const d = data.find(x => x.idOp === idOp);
      if (!d) return;
      const v = parseFloat(document.getElementById(`tasa-${idOp}`).value);
      const btn = document.getElementById(`btn-${idOp}`);
      const input = document.getElementById(`tasa-${idOp}`);

      if (!isNaN(v) && v !== d.tasa) {
        btn.disabled = false;
        btn.classList.remove('muted');
        input.classList.add('changed');
      } else {
        btn.disabled = true;
        btn.classList.add('muted');
        input.classList.remove('changed');
      }
    }

    // -------------------------------
    // Guardar cambios (Backend Flask)
    // -------------------------------
    async function guardar(idOp) {
      const d = data.find(x => x.idOp === idOp);
      if (!d) return;

      const input = document.getElementById(`tasa-${idOp}`);
      const btn = document.getElementById(`btn-${idOp}`);
      const nuevaTasa = parseFloat(input.value);

      if (isNaN(nuevaTasa)) return alert("Ingresa una tasa v√°lida.");
      if (nuevaTasa === d.tasa) return alert("Sin cambios: no se env√≠a notificaci√≥n.");

      const body = { idOp: d.idOp, tasa: nuevaTasa, email: d.email };

      btn.disabled = true;
      btn.classList.add("muted");
      btn.textContent = "Enviando‚Ä¶";

      try {
        const res = await postWithRetry("/api/guardar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        let result = {};
        try {
          result = await res.json();
        } catch {
          throw new Error("Respuesta del servidor no v√°lida");
        }

        console.log("üîÑ Respuesta del servidor:", result);

        if (!res.ok) {
          throw new Error(result.error || result.msg || "Error en la respuesta del servidor");
        }

        alert(`‚úÖ ${result.msg || "Tasa actualizada correctamente."}`);
        await cargarDatos(); // recarga desde el backend real

      } catch (err) {
        console.error("‚ùå Error durante el guardado:", err);
        alert("‚ö†Ô∏è Error: " + err.message);
      } finally {
        btn.textContent = "Guardar";
        markChanged(idOp);
      }
    }

    // -------------------------------
    // Inicializar
    // -------------------------------
    checkAuth();
    cargarDatos();
  </script>
</body>
</html>
